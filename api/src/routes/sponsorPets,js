const express = require('express');
const app = express();
require("dotenv").config();
const { PROD_ACCESS_TOKEN } = process.env;

// SDK de Mercado Pago
const mercadopago = require("mercadopago");
// Agrega credenciales
mercadopago.configure({
  access_token: PROD_ACCESS_TOKEN,
});

//Routes
app.post('/preapproval', (req, res) =>{
    console.log(req.query);
    // Crea un objeto de preferencia
    let preference = {
        items: [
        {
            // preapproval_plan_id: "",
            reason: "Sponsor pet from Petbook",
            payer_email: "matias.henriquez.dev@gmail.com",
            card_token_id: req.body.token,
            auto_recurring: {
                frequency: 1,
                frequency_type: "months",
                transaction_amount: 1500,
                currency_id: "ARS"
            }
        },
        ],
        back_urls: {
            success: "http://127.0.0.1:5173/thanks",
            failure: "http://127.0.0.1:5173/failure",
            pending: "http://127.0.0.1:5173/pending"
        },
        auto_return: "approved",
    };
    
    mercadopago.preferences
        .create(preference)
        .then(function (response) {
        // En esta instancia deber√°s asignar el valor dentro de response.body.id por el ID de preferencia solicitado en el siguiente paso

        
        res.redirect(response.body.init_point);

        })
        .catch(function (error) {
        console.log(error);
        });
    })

    
  

module.exports = app;